弥媒和应用体系
========  
### 概述
当前互联网最大的问题在于寡头垄断了用户数据，通过规则影响和控制用户行为，并获取巨额利润。垄断造成了互联网企业的极端贫富分化，抑制了竞争和创新，互联网正在失去发展的活力。打破寡头对互联网的垄断，成为越来越迫切的需求。

Leither是一个去中心化的云操作系统，能够以去中心化的方式重构传统的互联网平台业务，让用户重新掌握数据的所有权和使用权。Leither云系统包括去中心化的文件系统、数据库、应用体系、用户安全体系、网络体系等模块；在应用体验和协议上尽可能与传统兼容。

相较于传统的云服务模式，应用体系有以下优点：
+ 开发应用极简单；
+ 系统资源消耗极低；
+ 带宽流量低成本；
+ 可以用简单的方法实现弹性伸缩。

在Leither上对标一个传统互联网应用，比如淘宝，发起者只需创建一个Leither组织，写好共识合约来描述项目参与方的通证（token）分配机制。通证是用户贡献的凭证，可以按比例获取组织的业务收益；可以用于交换这个组织提供的服务，服务包括组织的业务本身、流量广告、节点信息路由、域名解析、内容检索、数据备份、业务支撑的带宽存储空间、CPU算力、合约验证、挖矿时的质押等。

组织参与者包括发起者、投资者、开发者、内容或服务提供者、设备支持者、运营推广者等。组织业务收益的分配通过共识机制保证。设备支持者对应区块链项目的矿工。设备既可以完成原来的记帐功能，也可以支撑更有价值的组织业务。和传统的区块链相比，Leither区块链在价值、成本、效率、功能、隐私等方面都有优势，更重要的是完全符合法律法规。

本文中涉及的相关概念定义如下：  
+ **弥媒**  
弥媒是Leither系统中最核心的创意，参考基因和弥母（Meme）的概念创制而成。弥母一词源自英国科学家理查德-道金斯（Richard Dawkins）所著的《自私的基因》（The Selfish Gene）。弥母可以简单地理解为文化基因，是一种可以通过模仿等方式在人与人之间传播的文化或者行为元素的载体。  

	弥媒是互联网中信息的载体，描述了信息数据的存储方式，也定义了信息相关的应用操作，包括不限于打开、生成、存取、保存、检索、展现、用户交互等；弥媒之间有引用关联，可以构建出复杂的互联网应用和服务。

+ **Leither**  
Leither是一个弥媒的容器，也是一个超轻量级的去中心化的云操作系统。  
Leither能够以极低的资源支持常见的互联网应用，例如网站，公众号，小程序，APP等；  
Leither系统实现了认证体系、应用体系、文件和数据库系统、域名和网络系统。API支持常见的四十多种语言。  

+ **节点**  
Leither OS内核文件只有6MB，可以运行在常见的操作系统上，如Windows、Linux、FreeBSD、Darwin、Android等；由于对硬件要求极低，PC、手机、NAS、路由、树莓派等各种设备均可支持Leither。运行了Leither OS的设备称为Leither节点，简称**节点**  
1. 一个节点，可以当成轻量级的主机使用；  
2. 两个节点，可以互助，进行数据互备、容错和均衡，域名解析和路由等操作；  
3. 多个节点，能够以去中心化的方式重构常见的互联网应用。  

	**_弥媒可以在节点之间自由流动，从而实现去中心化的目的。_**  

### 一、去中心化网络的需求分析
我们的目标是构建去中心化互联网。在分析问题提出方案之前，需要整理一下计算机和互联网发展各时期的需求，以及当时为解决这些需求而提出的方案模型。这些需求如果不能被满足，新的方案就是不完备的，无法替代现有的方案。  
#### 1.1 文件——数据载体  
计算机诞生初期，在Unix中，设计了文件这样的数据载体；同时为了管理文件和存储介质，设计了文件系统。
一切皆文件，所有信息相关的设备都通过文件表达。  
#### 1.2 MIME——数据类型  
随着应用的增加，需要表达文件和应用之间的关联。在DOS中有了扩展名的概念。到了Windows中，扩展名已经可以和应用进行绑定。  
在电子邮件的MIME中，对文件（附件）类型有了严格的定义，目前的浏览器都对这个定义进行了支持。
#### 1.3 数据库——数据间关联  
为了处理复杂的数据关系，数据库应需求而生。数据库还是封闭的数据集合，是一个体系内的关联关系。   
缺点：数据存放在封闭空间，不能自由流动，限制了价值最大化  
#### 1.4 HTML——数据跨点关联  
WWW从规则上定义了数据和数据之间跨文件跨主机的关联。数据可以跨节点关联，突破了主机空间对数据的限制。互联网诞生，信息大爆炸。门户网站充分利用了这一特征，获得的蓬勃的发展。  
缺点：基于链接的关联不够精确稳定。
#### 1.5 Google——数据检索  
信息大爆炸，产生了检索的需求。Goolge通过给数据附加标签的属性，提供了一种根据关键字进行内容检索的服务。    
缺点：日益垄断，日益封闭，数据获取规则被干扰控制。
#### 1.6 Facebook——社交模型  
最早的社交通讯工具ICQ、MSN、QQ解决了人和人之间的实时消息通讯问题；Twitter提供了一个更快速简短的信息分享平台；  
从MySpace到Facebook一个更系统的社交模型诞生了，这个模型分四部分：  
|序号|名称|说明|
|--|--|--|
|1|我|主要是管理用户个人相关的的信息|
|2|朋友|用户的关系链|
|3|应用和服务|用户使用的应用和服务 |
|4|消息流|用户和外界的互动区，互动对象是朋友、应用、服务等|

这个系统模型非常成功，后续出的互联网平台产品都在向这个架构靠拢。典型代表是微信、微博、阿里来往、支付宝、一些企业OA系统，都或多或少有这个框架的影子。
缺点：互联网日益垄断，日益封闭，规则被干扰控制。
#### 1.7 去中心化设计原则   
+ **一切以用户为中心**  
用户构建、用户控制、用户享有  
A new birth of freedom and that internet of the people, by the people, for the people. 

+ **规则自由开放**  
1. 网络底层协议是开放的；  
2. 底层操作系统规则是开放的；  
3. 规则开放，用户才有选择权，用户才有控制权。

+ **数据自由流动**  
在用户许可、安全可靠的情况下，用户数据可以从一个平台流动到另一个平台，可以从一种形式转换成另一种形式。  
数据能自由流动，第三方才可以为用户提供丰富多采的应用和服务。  

结合计算机和互联网的历史，Leither需要满足如下需求：
+ 支持文件、文件系统和数据库  
+ 支持数据和应用的关联  
+ 支持跨节点的内容关联  
+ 支持跨节点的检索  
+ 支持跨节点数据流动  
+ 支持去中心化的社交模型  
+ 支持轻量级的容器系统
+ 支持简洁的应用开发方式
+ 用户体验要和当前互联网兼容
+ 合法合规兼容当下的社会制度  

### 二、数据是如何被垄断的 

#### 2.1 数据垄断的形成  
在传统的操作系统上，文件可以在各终端和平台之间自由存取复制。互联网初期，用户数据访问是通过统一规则是互相开放的。谷歌、微软等大平台都提供了访问用户数据的API。最早的数据垄断来自于Facebook，它利用各大公司提供的关系链数据构建了自己的社交媒体，然后断绝了第三方对用户数据的访问，用户数据被限制在了FB内部。

随后亚马逊苹果等公司纷纷建立了自己的数据王国。互联网日益孤岛化，堡垒化，用户的数据被割裂保存在不同的寡头平台。  

访问数据的两种形式：  
**数据->应用**  
用户可以自由接触到数据，然后调用数据相应的规则。Windows中，用户可以选择不同的应用打开同一类型文件；电子邮件中，用户可以选用不同的应用打开附件；同一个网址，可以选用不同的浏览器打开。在这种情况下，用户可以可以自由选择应用，不被单一应用所限制。 

**应用->数据**  
用户访问数据时，数据被特定的应用规则保护，限定了用户只能通过一套规则进行访问。用户在电商平台购物，登录电商平台，查找商品，进行购物； 用户在社交媒体上访问社交信息。在这种情况下，应用中的算法规则决定了用户访问数据的行为路径，用户的行为被应用中的算法规则所控制。  

在编程思路上，以上两种刚好对应“**面向对象**”和“**面向过程**”  

#### 2.2 破除数据垄断的措施  
**平台公器化**  
Microsoft借助操作系统控制了整个PC的应用生态，在办公软件和浏览器等领域都利用操作系统扼杀竞争对手。阿里、百度、谷歌、亚马逊等一些内容站是通过内容检索控制用户数据和行为；腾讯、脸书是通过社交网络控制用户数据和行为。  

开源社区利用Linux把操作系统变成了公共平台（公器化）。类似的例子还有Android，芯片开源指令集架构RISC-V。  
对于存放用户数据的平台，应该有开源的平台架构。 当前互联网最应该公器化的是**社交网络**和**内容检索**两个部分。    

**数据能自由流动**  
数据能自由流动应该成为大家的共识，也应该成为基本的设计规范。为此应进行下述三方面工作：  
+ 广为宣传使之成为主流的价值观;  
+ 促进各国制定法律法规成为行业规范，对于保存在用户平台上的数据，必须支持用户导入和导出的接口（最近欧盟拟对谷歌、苹果提出类似法案）;  
+ 发动类似浏览器插件这样的开源项目，组织研发人员把用户数据从寡头的平台上导入到用户的空间，数据到了用户空间，便可以对用户的数据复活及再关联。  

**规则从属于数据**  
数据能自由流动的情况下，用户可以选用不同规则去操作数据；换个说法，尽可能使用**面向对象**的开发方式，避免**面向过程**的开发方式。  
在**面向对象**的开发方式中，只要能确保数据对象能够自由流动便可。数据结构通常相对简单，易于逆向获取。在知道数据结构的情况下重构规则相对容易。  

**用户数据颗粒化**  
对于耦合在一起的大规模数据，我们是没办法单独剥离的。在设计上应该尽可能的让数据颗粒化。颗粒化的原则是象基因一样，尽可能包含相对完整的信息。  
信息相对独立，能够独自和算法规则结合。和外部的关联简洁清晰，能够为算法和规则表达。常见的动态语言都适合算法规则的颗粒化。

**数据和数据关联**  
孤立的数据价值是有限的，不同数据之间应该能够互相关联，这样才能够表达更复杂的内容。  
Html之间通过链接进行关联，除了链接不稳定以外，这是非常不错的一种表达关联方式；数据库的数据关联都是内部关联，限制了广泛的信息互动。

#### 2.3 数据容器  
数据要回归用户，首先需要一个设备来存放用户数据。这个设备最好是用户拥有的私人物品，成本要可控，轻量级免维护，类似Solid中推荐的Pod。。  
相对于一些区块链提出的**同态加密**的技术，本方案更加简单有效。完全控制一个数据终端，就完全控制了数据和应用规则。

### 三、弥媒概述
**弥媒由来**  
信息熵是宇宙和人类发展过程中重要的一个物理量。熵增定律为宇宙演变指明了一个方向。熵也被称为时间之箭。薛定谔在《生命是什么》中提到：人活着就是在对抗熵增定律，生命以负熵为生。    
  
生命把环境的信息记录在了基因**Gene**里，通过遗传适应之前的环境，通过变异筛选适应环境的变化，生命体则负责解释执行这些信息。人类有了意识之后，可以在大脑中对环境进行模拟调整，在大脑中处理相应的信息。这些信息的基础单位被查德-道金斯称为弥母**Meme**    

计算机和互联网诞生以后，信息的处理方式发生变化，需要一种新的单位来描述信息，我们称之为弥媒**Mimei**。除了象基因和弥母一样，弥媒能包含一段信息，同时也定义了和信息相关的规则。

**弥媒功能**  
基于**1.7 去中心化设计原则**所提的需求，弥媒实现了以下功能：    
+ 弥媒通过应用生成、管理、存取、展现、传播  
+ 弥媒基于内容主题创建，每一个弥媒都有一个唯一ID  
+ 用户可以设置弥媒的各种权限  
+ 弥媒和弥媒之间通过引用进行关联  
+ 弥媒可以运行保存在一个或多个节点上  
+ 象Git一样，弥媒有版本的概念，版本主要是解决数据的一致性问题  
+ 节点之间的数据库可以实时同步变化，也可以备份后再进行同步   
+ 弥媒目前描述的数据类型有数据库和文件，后续会支持流  
+ 文件系统是特殊的系统类型，基于数据库和文件完成  
+ 每个弥媒都可以有独立的数据库和文件系统空间  
+ 弥媒通过不断的修改备份完成内容的继承进化  
+ 用户也可以用分支的方式完成弥媒内容的变异  

Leither是我们实现的一个弥媒容器系统，同时也是一个去中心化的云操作系统  
<a href="../api/MiMei.md"> 点击查看弥媒相关的API</a> 

**弥媒特点**   
|特点|说明|
|--|--|
|唯一性标识|弥媒的ID和版本机制，可以精确稳定描述信息|
|表达复杂信息|支持数据库和文件系统，支持弥媒关联，支持应用，可以表达复杂信息|
|信息自由流动|可以构建关系链和不同的群，弥媒可以根据用户行为在不同节点之间流动|  
|多元信息检索|每个用户都可以为弥媒构建标签，可以通过不同用户节点定制多元的信息检索结果|
  
以上特点，后文会详细叙述  

### 四、弥媒标识
**弥媒ID**  
在Leither定义的去中心化网络生态中，所有的资源都是用ID来描述的，包括用户、节点、内容、应用等。用户和节点的ID是基于公私钥产生的，一个文件和数据块的标识ID是基于内容取摘要产生的。  

弥媒有内外两套标识：    
+ 对外的标识是弥媒ID  
弥媒ID是代表弥媒的唯一ID，是基于创建者、关联应用、弥媒类型、弥媒标识产生的。创建之后，不管怎么改变内容，弥媒ID都是不变的。 弥媒ID可用于弥媒的检索、操作、引用关联。  

  弥媒的数据存在文件或数据库中，每次修改备份之后，会产生一个新版本。 版本号从0开始，每次备份增加1, 依次是:0,1,2,3,4....  
  为了便于操作，用“last”来代表最后一次备份的版本。  
  
+ 对内的标识是内容摘要ID  
  弥媒的每个备份版本指向一个文件或数据库的ID  
  ID是根据内容摘要生成的。    

**弥媒信息**  
弥媒的信息用以下结构创建和表达：
```golang
type MiMeiInfo struct {
	Author  string    //作者
	AppType string    //应用类型
	Ext     string    //扩展信息
	Mark    string    //标识
	Create  time.Time //创建时间
	Right   uint64    //权限
}
``` 

**通过弥媒ID和版本获取弥媒数据**  
弥媒在编辑的过程中、备份的时候生成版本，这个版本对应的数据是基于内容摘要的。版本备份之后内容确定不再修改。 可以根据弥媒ID和版本获取到指定的弥媒数据。

### 五、数据存储和关联
弥媒支持文件和数据库系统，能支持绝大多数互联网应用的数据存储需求。

#### 5.1 信息颗粒化
弥媒是把信息进行颗粒化的。针对以下数据，建议进行弥媒化：  
+ 需要检索的内容  
+ 需要在用户之间分享的内容  
+ 需要在节点之间流动的内容  

弥媒化可以提前进行，也可以在需要的时候进行转化，后者本质上是原来的弥媒分裂成了两个弥媒，新的弥媒数据从原有的弥媒中脱离，原有的弥媒中分裂出的部分变成了一个指向新弥媒的引用关系。  

Leither提供数据库和文件系统，对于用户自用的数据，用户完全可以仿照传统的方式进行开发维护。在这种情况下，是根据用户或应用构建一个大的弥媒。  

#### 5.2 弥媒版本机制
弥媒的文件和数据库都支持版本机制  
* cur代表当前修改中未备份的版本，代表在实时修改   
* last代表最后一备份的版本，代表最新的固化内容  
* release代表审核过，确定可以对外发布的版本  

有了版本机制，我们便可以通过唯一ID获取不同版本的弥媒数据。   
_可以根据弥媒id和版本号cur获取最新的弥媒数据。_  
_可以根据弥媒id和版本号last获取最后备份的弥媒数据。_  
_也可以根据弥媒id和版本号release获取最稳定的弥媒数据。_  
_也可以根据弥媒id和指定的版本号获取任一指定的版本的弥媒数据。_  

#### 5.3 弥媒的关联
孤立的数据不能表示复杂的信息，弥媒有了唯一标识ID，可以构建相对稳定的关系结构。信息存储在弥媒的文件或数据库中，存储的格式由关联应用确定。  

弥媒之间的关联由引用确定，引用信息包括弥媒ID和引用数。正常情况下数据内容中的语义关联都是由应用规则解释的，系统无法获取，需要应用主动调用API维护弥媒引用。  

大部分弥媒所表达的只是一份内容片段，通过关联性，我们可以表达相对完整，更加复杂的内容。  

#### 5.4 文件系统
传统操作系统上的文件系统诞生的背景是计算机都是大型的昂贵设备，上面的应用和数据也不多。文件系统避免了应用直接操作和管理存储介值，从而提高了效率。  
随着计算机、互联网和移动互联网的发展，用户、应用、数据都爆炸式增长。文件系统开始暴露出以下缺陷：  
1. 文件名标识文件不精确  
2. 检索信息不足，只有路径和文件信息  
3. 同一个文件会被多次存储  

我们把传统的文件系统转化为弥媒框架，进行以下改造：  
* 唯一标识：每个保存信息的文件都根据摘要生成ID，作为文件标识  
* 当前版本：弥媒的当前版本处理频繁的读写  
* 引用使用：不直接保存数据，增加资源引用数，通过引用资源的唯一标识使用资源。  

对于文件系统的目录结构，我们也进行**信息颗粒化**（5.1），对需要分享或需要检索的热门有主题的目录，可以转化为弥媒。  
目前Leither采用json格式的弥媒文件保存目录。取摘要的方式类似Merkle树。  
Leither系统具备完整的文件和数据库操作指令和API。

### 六、Leither应用体系
#### 6.1 Leither方案
Leither Api支持40多种语言，重点支持Html5。因为目前互联网上大量常见的应用形态都是基于Html5完成，包括网站、App、公众号、小程序等。  Html5并不完备，没有为后端数据和业务逻辑制定标准。Leither补充了Html5构建云应用时缺少的环节， Leither提供用户和安全认证机制，提供了应用体系，提供了云端的文件系统和数据库系统，提供了去中心的域名解析机制，冗错及负载均衡机制。

**业务前端化**  
除非必要，业务缺省放在前端执行。这样的好处是用户开发的时候和本地页面开发差不多，不需要学习更多的技术。

**瘦节点**  
手机和PC不能稳定的服务输出，服务器过重限制过多，路由器和机顶盒通常厂家都有一定的限制。NAS和其他可以定制的硬件比较适合。  
业务前端化加上个人业务量不大，比较适合这种弱CPU的设备

**针对性优化**  
对于特殊情况，节点也支持批量执行请求，后台任务；  
个人终端没有专业的运维人员维护，节点构建和应用安装需要简单，使用过程需要免维护；  
对家用网络环境做了优化，提供了去中心化的域名体系，可以实现类似云主机的效果。  

**应用弥媒化**  
Leither提供了完整的应用体系，系统中的应用本质上是一种弥媒。  
<a href="Applition.md">应用体系的详细文档</a>

#### 6.2 设计思路
**Html5是互联网的核心标准和规范**  
目前互联网上大量常见的应用形态都是基于Html5完成.
应用包括网站、App、公众号、小程序等。

**Html5并不是一个完整的互联网应用解决方案**  
Html5标准中只提供了本地化存储方案（Web Storage与IndexedDB），并没有为后端数据和业务逻辑制定标准。这造成了常见的HTML5应用严重依赖后端来实现业务逻辑和数据存储。因为不触碰核心的业务逻辑和底层数据，前端程序员通常在各种开发人员中处于歧视链的底层。

**Leither补充了Html5构建云应用时缺少的环节**  
Leither提供用户和安全认证机制，提供了应用体系，提供了云端的文件系统和数据库系统，提供了去中心的域名解析机制，冗错及负载均衡机制。

**Leither非常适合构建云服务**  
除了能完整构建云应用，Leither系统内的应用和数据资源都是可以流动的弥媒形态，加上负载均衡机制，使得Leither成为构建云服务平台的理想选择。在开发过程中应尽量引导开发者把计算放在前端进行，这样大量减少了对主机的要求。同一台主机保守可以比传统方式高一到两个数量级，两者的效率差可以进行量化计算和直接评测。

#### 6.3、构建云服务的优点
**开发应用极简单**  
学习完Html5就可以成构建云应用的绝大部分工作，独自完成网站，App,公众号，小程序的开发。整个过程和开发html本地应用相似。

**系统资源消耗极低**  
Leither系统是为低CPU低内存的设备进行开发的，应用对系统的消耗极低。
应用中的计算缺省使用前端资源，特殊优化时才会使用节点资源，这样大量减少了对节点硬件的要求。
同一台主机保守估计可以比传统方式高效一到两个数量级，可以进行量化评测。
对于超大运算量的业务，可以提供API和专业的计算节点配合完成。

**带宽流量低成本**  
对于大流量的应用，系统可以以高效稳定的方式均衡到家用网络节点上，两者之间的成本相差10倍以上。

**可以实现弹性伸缩**  
系统应用和数据都支持docker一样的空间隔离。应用文件和数据库都支持版本式的备份。
同一台物理主机可以同时支撑多个用户多个应用和相应的业务数据。
支持在域名和链接不变的情况下，应用和数据根据需求在不同物理主机之间进行流转。  
弹性伸缩功能由去中心化域名和弥媒机制支撑完成。

### 七、弥媒信息流动
**信息扩张是生命的意义**  
基因，弥母是记载了生命的信息，生命存在的意义就是使在些信息占据更多的时空。弥媒存在的意义是使有价值的信息更广泛的传播。  

**流动的信息才是有价值的**  
FileCoin中传递了一个错误的概念：数据是资产。数据本质上是一种负资产，设备、硬盘、网络都需要消耗成本。高价值的数据只有流动起来变成流量才能产生价值。支持数据的业务主要是存取。  
支撑流量的业务流有以下环节：业务体系开发、内容的产生（制造采集等）、保存、传播、展现、价值实现。内容每一次展现都产生了价值。展现次数和单次展现价值决定内容的产生价值。   

**信息流动是业务的需求**  
在传统的互联网中，数据备份、容错、均衡、云业务的弹性伸缩本质上都需要信息进行流动。
  
信息流动有两种情况：  
+ 主动保存  
通常是因为弥媒的价值比较高，保存能产生后续价值。
+ 请求帮忙保存
通常是当前节点的支撑能力不足，需要其它节点帮忙安全备份容错，负载均衡等。

保存的流程：  
+ 信息弥媒化  
信息弥媒化之后，分享的内容可以备份成文件块。  
+ 节点复制数据  
在有对方节点相应权限的情况下，把弥媒的数据块从一个节点复制到另一个节点上。  
+ 更新弥媒的路由信息  
最终内容消费者是先获取弥媒的路由信息，再根据路由信息访问弥媒数据，路由信息中有弥媒的节点信息和最新变动信息。更新弥媒路由信息后，用户可以获取到最新的弥媒信息

### 八、社交模型和信用体系
前文（2.6）提及了当前的社交模型分四个部分：我、关系链、应用服务、消息流。
Leither中相应的模块如下，详情见相应模块的文档
|名称|说明|
|--|--|
|我|认证体系确定用户身份，|
|应用和服务|应用模块处理用户使用的应用和服务 |
|消息流|消息模块处理用户和应用间的交互信息|

后续重点描述关系链和信用模型。

#### 9.2 信用模型
用户（节点）和用户（节点）之间需要有信息和服务交互，交互过程中需要进行量化结算。  
在现实世界货币是人和人之间的信用结算工具；在Leither网络中，是通过信用方式进行交换。

每个节点都可以对其它节点进行信用授权，这个授权是允许别的节点可以使用我的节点的服务。节点和节点之间服务量的差是借方向出借方签发的借条，也可以理解成借方发行的货币。对于一个群体组织，组织发行的货币本质上是成员向组织贡献的凭证，这个奉献可以是有价值的劳动、资源等具体能推动组织发展的价值等价物。这个凭证可以向成员交换组织服务或其它价值。  

**信用标的**  
信用标的最高的是现实生活中的法币。在Leither网络中，节点和节点之间互助的服务可以作为标的。  
可供选择的标的有：存储 带宽 CPU  
根据节点网络的特点，其重要性排序如下：带宽 > 存储 > CPU   
我们会优选带宽作为节点间结算的基准单位，其他类型的服务通过系数进行转换。此外，信用标的也可以是现实世界的法币    

**个人信用模型**  
这种信用模型是用户与用户之间（点对点）的信用证和借条
+ 信用证  
信用证可以理解为允许先使用后付费的服务量，借条可以理解为已使用未付费的服务量。  
信用证包含以下信息：授权方、接收方、信用单位、信用上限，授权方签名;
+ 借条和货币  
借条包含以下信息：
借出方、借入方、信用单位、出借数额、借入方签名。
对于借出方来讲，这是**借条**，
对于借方来说，这相当于发行了**货币**  。

**信用构建**
+ **信用授权**   
关系链在建立的时候，双方有互信基础，可以根据关系的远近进行不同数据量的授权。

+ **定期增信**  
两个节点在建立关系之后，可以通过定期增信的方式增加信用。

+ **互助**  
用户节点在建立的时候，同时具备了提供服务的能力。可以通过主动向对方提供有益的服务获取信用，例如数据备份、均衡、路由、检索、中介等服务。

+ **信用撤销**  
发现对方有严重的违法等不良行为时，用户可以主动撤销给对方的服务。

+ **主动获取**  
用户可以通过线下方式购买或者沟通等行为，促使用户提升信用。

+ **信用交换**  
用户可以通过第三方用户或组织进行信用交换。 
组织和信用体系参见<a href="./GongShi.md"> 组织和共识机制</a>

**交易流程**  
在有信用的前提下，用户可以通过信用交换服务，同时生成相应的记录。
在超出信用的情况下，服务方停止向对方提供服务。 

**信用中介**   
没有直接关系的节点，可以通过中介节点进行信用交换。
也可以通过共同信赖的中间媒介来进行，例如法币、虚拟币，或者后文会提及的**群体货币**进行交换。

### 一、组织
在<a href="./MiMei.md"> 弥媒和应用体系第九章</a>我们提出了以个人为中心的关系链模型，以及基于这种关系链的信用模型。在现实社会中，人也经常是各种社会组织的一员，需要去描述社会组织。在社交网络上，通常称之为群组，简称群。本文称之为组织。  

组织结构以群体为中心。先有群这个组织，然后才有群成员的加入。有三种不同的身份，管理员（创建者）、群成员、Guest用户。群由群主或群成员共同维护和管理。在传统互联网中，整个系统都有平台方负责构建维护，所有的规则都有平台方所把控。 

维护群是一个群的公共服务，需要有类似区块链的方案进行协调各参与方的利益。我们可以把更强的公共服务附加在群上，这时候群就变为一个组织。当前互联网的实体组织都可以Leither群组的形态进行重构。

### 二、组织服务
组织服务是组织对内或对外提供的服务。当前互联网上的 大部分业务，都可以用组织服务的形态进行重构。  

#### 2.1、 **业务分类**  
常见互联网业务根据其的核心特点，可以分为：检索类、内容类、社交类、工具类  
+ 检索    
  百度、阿里、谷歌、亚马逊等公司获利基于**检索信息**。    
  在Leither网络中，任何一个用户根据偏好定制检索信息源和检索策略。    
  这样检索信息不被少数公司把控，用户自己控制和决定自己的检索信息。 
   
+ 社交  
  微信、微博、脸书、推特等公司获利是通过控制用户的**社交关系**。  
  在Leither网络中关系链回归到了用户保存。相应的消息流，应用、服务等附加内容都由用户自己选择定制。  
  
+ 内容和服务   
  Youtube等视频平台，网易云音乐等音乐网站，新闻网站等获利基于**内容和服务**。  
  在Leither网络中，服务和内容可以拆分成小模块，然后包装成弥媒。  
  内容创造者可以直接上传到自己的节点，也可以通过插件方式把传统互联网上的内容采集到自己的节点上。  
  弥媒可以跨节点进行流动，消费者也可以自定义检索内容服务的方式和途径。
  不再被少数寡头控制。

+ 工具  
  谷歌文档，在线office,xmind脑图等获利是基于提供**工具服务**。  
  在Leither网络中，应用也是一种弥媒。

#### 2.2、 **业务分工**  
把互联网的上述业务进行拆分，在Leither生态中由下面这些成员用去中心化的方式协作完成。

+ 应用开发  
  为生态开发应用和平台，由开发人员完成。
  相当于传统互联网中的研发部门  

+ 服务或内容生成  
  为生态服务提供服务和内容，对于内容服务，是传统互联网中的小编、运营公众号的作者等。
  相当于传统互联网中的运营部门

+ 服务支撑  
  为整个生态提供物理支撑，由运维人员完成，和传统互联网不同，设备不再属于某一家公司。
  这部分相当于传统互联网的运维部门

+ 服务推广  
  一种方式是做成网站、链接、公众号、小程序、APP等去传统的互联网中推广。
  一种方式是对内容生成标签，由检索节点的方式提供公共服务。
  这部分相当于传统互联网的运营部门  
    
+ 价值变现  
  每个节点都能提供服务能力，这些服务能力可以货币化，用于支付其它服务内容。
  生态中的信息检索和流量展现都有巨大的商业价值，是整个生态的**价值来源**  
  通过类似区块链的技术构建共识机制，利用共识协调生态中各个成员的投入和回报。
  后文会详细介绍


#### 2.3、 **服务支撑**  
节点自身的管理、流动的弥媒、检索信息、群组共识等
+ 弥媒存储  
  Leither把互联网的内容和服务都肢解成了弥媒形态。  
  弥媒根据业务需求存放在节点上；弥媒根据需求在不同节点之间流动；节点之间的服务通过信用进行结算。
  通过群共识参与群服务的结算。共识机制参见章节“共识机制”

+ 索引信息  
  这部分用于信息的检索。  
  这些信息存放在，所有入网节点公共信息区域（DHT）上。通过群共识参与群服务的结算。 

+ 对接服务  
  这部分是和传统互联网进行对接的部分，是APP、域名解析、公众号、小程序等。
  这些服务运行在传统互联网的主机上，通过群共识参与群服务的结算。

+ 共识  
  群组的公共业务逻辑。  
  共识运行在所有的记账节点上  

### 三、功能描述  
#### 3.1 创建组织  
任何一个用户都可以创建一个组织。创建时，系统生成一对组织密钥，公钥id缺省是组织的ID。创建者是组织的缺省成员和管理员。组织有和弥媒相同的权限机制，用户分管理员，成员，Guest用户。  

创建之后，组织运行在了创建时候的节点上。分布式的组织网络也开始在这个节点上工作。系统缺省的网络结构是DHT网络，这个网络保存群的公共信息。  

通过DHT网络可经查询群的公共信息，可以查询成员的节点信息，成员之间可以点对点发送消息。群聊信息属于公共信息，保存存在DHT网络上。  

#### 3.2 加入组织  
用户可以申请加入一个组织，可以通过任何一个在网的组织成员，用户向组织递交加入申请。管理员批准之后，用户就成为群成员，相关信息写在了dht网络上，同时也可以检索查看组织的公用信息。
  
用户也可以通过完成组织任务，获取组织奖励的方式，获得成员权限。

#### 3.3 发展业务  
组织业务本质是一系列的Leither应用，可以通过Leither应用体系发布在组织网络的公用信息区域。  

以视频网站为例，业务可以肢解为：  
+ 内容的采集和生成
+ 内容的标签分类
+ 应用支撑，提供资源，包括不限于存储、带宽、CPU
+ 内容访问通道。APP、小程序、公众号、域名解析、路由解析、内容检索等
+ 推广，把内容推送到需要的人那里。。 
+ 价值实现。

这里的价值实现有两类：  
一类是价值中包括了第三方价值，第三方会提前支付推广费用。
一类是对普通用户有价值的内容和服务，通过普通用户付费或者广告的方式获取收益。广告模式是验证的高效模式，当前互联网有成熟的产业生态。

### 四、价值体系
**价值的来源是有意义的劳动成果**，这是价值体系设计的基本准则。   
每个分发的价值都指向一个有意义的劳动成果，价值的大小来自这个成果对整个生态的意义大。也就是有多大用。  

通过共识机制，我们可以生成一个组织账本，本质上是一个具备时空镜像功能的稀疏默克尔树。   
组织分发出的奖励都是写明原因和理由，组织内部进行公开。  

有别于工作量证明(POW)，我们可以称之为劳动成果证明或业绩证明（Proof of Performance）。

系统的奖励有以下几种：  
+ **架构性奖励**  
对于组织的基础性贡献、组织者、财务投资人、系统和应用的开发者。  
这些都是支撑组织运作的必须服务，可以通过管理员发起，投票的方式进行转账。  

	这个奖励用于组织构建

+ **内容服务类奖励**  
组织提供对他人有价值的内容和服务，在价值创造的各个环节，记录每个价值的贡献者。在完成价值的点，触发奖励发放的合约，对各个环节进行贡献的角色进行奖励。  
奖励的分配可以是固定比例的方式，也可以是动态平衡的方式。  
模拟流程如下：  
1、开发者编辑内容采集插件  
2、采集者使用插件，从传统互联网采集内容，生成弥媒，以弥媒的方式发布内容到网络，弥媒结构上记录创建者是采集者。  
3、运营者用各种方式，包括不限于检索标签，app,公众号，小程序、运营、微信群推广等方式反内容展现给用户。  
4、用户浏览内容，同时展示广告，形成传统互联网中的流量 。  
5、展示页面中有广告方认同的检查机制，流量信息会触发合约，代币会根据信息分别把代币从广告方账户支付到整个流程参与者的账户。  

	这个奖励使系统健康成长，对他人有越来越高的价值

+ **挖矿奖励**  
这是传统意义上的挖矿，所有在线的节点，都可以参与投票记账和合约服务，在打块的时候发放奖励。
这个奖励用于网络支撑，管理公共信息、网络路由。  

	这个奖励确保组织处于活跃运作状态。

+ **运营类奖励**  
在项目初期，生态内的内容和服务还不足以形成价值闭环，可以通过合约的方式，在价值奖励之外额外发放奖励，加快形成健康的生态的过程。   

	这个奖励有助于组织早日度过成长期  


### 五、相关概念
本文用到的关键相关技术概念如下：    
**DHT网络**  
DHT，Distributed Hash Table，分布式哈希表。
通过DHT，可以根据ID快速检索到一个节点，并可以存取和这个节点关联的信息。我们也可以把属于组织的信息分布式的保存在整个网络中。

**稀疏默克尔树**  
跳表是redis和leveldb中使用的重要数据结构，它引入了**概率均衡**的概念，可以在基本不改变树结构的情况下进行各种操作。和传统算法相比，虽然性能有所损耗，但整体保持在同数量级上。用同样的方法，我们对默克尔树进行改进，提出了稀疏默克尔树的数据结构。   

稀疏默克尔树是保存组织的核心信息，包括类似区块链中的公共账本信息。   
树的每个叶节点都记录了一个组织成员的账户信息，账号就是组织中的成员ID,这个ID是由用户的公钥HASH生成，每个ID共20字节，160位。所有的可能账号都可以存放在一个160层的二叉树上。每个账号在树上都有确定的位置。实际应用中因为用到的ID远小于这个叶节点的规模，这颗树是一个稀疏的二叉树。树的根节点有两个子节点0x0、0x1，有四个孙节点0x00、0x01、0x10、0x11，如此类推，账号挂接在第160层。  

我们做一个优化，针对只有一个子分支的分支，我们可以压缩到上一级，这样可以大幅度压缩树的层高。对于随机分布的节点ID，网络中的节点数量是n，那么树的大部分节点都会挂接在log2(n)+1层的叶节点上，越接近根节点，这颗树越紧密。对于节点的增加和减少，或者账户信息的变动，只影响所在分支，其它不相干部分树结构都不需要调整。  

通过这颗树，我们可以快速的找到一个叶节点上相关的账户信息。有利于更简单高效完成后面的时空镜相、分片、心跳、转账、合约等操作。每个账号的账户信息都挂接在这颗树的叶节点上，每个分支根据子节点的hash节点和汇总信息生成本节点的hash。

**节点分组**  
随着网络规模和业务量的增加，从存储到数据处理到网络通讯必然会超出了一个网络节点设备所能承载的极限，如果不进行优化，就会出现类似比特币每秒只能处理7笔业务的窘境。  

因此我们对整个组织的账户进行分组，把稀疏默克尔树的每若干节点归为一个节点组集中管理，每个节点组在树结构上体现为一个稀疏默克尔树上的子树。  
节点组划分条件包括但不限于节点数目或级高。当前节点组上限是包含不超过256个节点。
超出的时候，8层子树内的节点保留，把超出8层的最大子树拆分出一个新的节点组。 这个节点组的id就是对应第8层子分支的id.
节点组内每个节点都有一个子分支的64位的id.  
这样一个节点组，最多可以存放256个节点，表达64层的不平衡子树。  

最下层的节点组子成员都是包含具体用户账户信息的叶节点，中上层的节点组的子成员除了叶节点，还可以包含下层的节点组。  
  
节点分组有两个好处：一是可以弹性伸缩提高并发性能，二是后面提到的隐匿网络，半透明化。   

**节点选举**  
每个节点组都有若干记账负责人，记账负责人负责节点组的账户交易的记录检查审核，并且负责相关信息的通讯和广播。  
节点组里的账户可以选举所在节点组的记账负责人，可以选举多个。投票额度累计不超过账户金额。  
选举的规则是共识的一部分，由组织者设定，可以根据质押资产的数量、网速的快慢等多方面综合考虑。
根据选举结果确定各级节点主备负责人。主负责人负责汇总记账，备份节点负责审核  
节点组也可以作为成员在上一级节点组进行投票，选出更高一级的节点组记账负责人  
最底层记账工作是详细的业务信息，中上层的记账工作是合并汇总分支中的变动信息，包括取摘要和汇总金额。  
在线节点不多或业务量不大的情况下，每个节点组不足以支撑一个记账人，这时候最底层的记账工作可以交给更上一级负责完成，也就是最底若干层的记账工作合并处理。  

根节点附近的顶层信息是全网同步的，这个信息描述了整个网络的当前状态。  

**网络心跳**  
为了协调各个网络设备节点之间的操作，系统定期（缺省心跳周期为1秒）生成一个递增的数据序号。  
这个数据序号相当于同步各节点时钟信号，也相当于数据的版本号。在一个心跳周期内，记账节点将上个心跳周期新增的数据进行因固化保存。根据网络的级数，每个节点组负责稀疏默克尔树的若干级数据处理工作。处理工作相当于传统区块链的打块，会获取相应的系统奖励。  
序号是由根级的记账负责人共同协商产生的，然后逐层广播到每个在线的网络设备。  

**时空镜相**  
Leveldb是一个优秀的写优化数据库。它通过流式记录新增变动的数据，可以极大的优化写操作，达到存储介值的极限，写操作甚至快于数据库的读操作。  
另一方面通过键值序号提供了修改的版本号，我们可以通过版本查询到历史记录的值。   
  
参考leveldb,我们把网络心跳对应leveldb中的数据版本序号。通过版本，我们可以快速记录并标识每一个周期内的变动信息。也可以用这种方式记录稀疏默克尔树时空树的快照。  
每个周期，除了新增的修改部分数据，前后两个版本的稀疏默克尔树结构是一致的，在给整个稀疏默克尔树做快照时，只需要保存变动信息便可，
通过键值中的版本序号，我们可以获取到任何一个心跳周期的任何一个节点数据。
对于具体的每一个普通账号，只需要记录自己的账户信息和所在分支的节点组信息便可。 

当前弥媒的数据库系统底层已支持类似的时空镜相功能。


### 六、相关流程
#### 6.1、网络构建
用户加入组织之后，便可加入DHT网络，成为DHT的一员。用户把自己的节点路由信息写入DHT网络，以便其它节点可以找到用户节点，进行通讯或使用用户的节点服务。

#### 6.2、账本构建
账本是一个有镜像功能的稀疏默克尔树，为了能够全网同步消息，全网会共用一个时间序号变量（下简称时序），初始值为0，系统定期（缺省1秒）产生一个心跳，如果系统状态有改动，时序加一，没有改变，则时序不变。  
系统定期（例如30分钟）会选出若干记账节点，互为备份，排在第一个的为主记账节点。记账节点任期为一个选举周期。记账节点负责所代表分支的相关记账工作。

<!-- tbd:待补充细节  
心跳的产生
选举方法如下，竞选节点在 -->

#### 6.3、转账流程  
**组织发放**  
最早的代币分配信息是全网公示的，写明理由，供全网审核查询。代币分配到用户之后，用户之间的转账是隐匿，或只向相关节点公示的。  

**用户转账**  
以两人转账为例，转账只和两个用户相关，两人确认之后，交易信息会附加两者的签名，通知给自己账号在稀疏默克尔树中的上级记账节点，上级记账负责人会把变动记录在各自的分支上。这个信息会在这一级的备份节点中进行广播。新时序产生之后（1秒），交易信息变成只读。各级记账节点开始从下到上检验和汇总分支信息，并生成摘要。总记账节点生成汇总信息和总摘要，并广播结果给各级节点。
交易双方记录时序、各层摘要信息和自己的账户信息。交易完成。
一次交易最多等待两个交易周期（2秒）  
交易过程中，备份记账节点，会检查信息是否正确，同时负责消息的收集和广播。

**争议处理**  
每笔交易都需要有足够的保证金背书（冻结）足够的时间，以供更多的节点进行审查。交易是同时多个节点处理，记账节点和备份记账节点都是随机分配的，避免串通的可能性。 任何一个节点有异议，都会进入争议流程，争议期相关金额会被冻结。全网对出错交易进行验证，根据验证结果进行投票，出错节点的保证金会被没收。记账节点只能处理冻结资金所支持的交易金额。  

**合法性检查**  
当事人检查整个交易是否合法  
上级记账节点检查总账是否平衡  
分支记账节点检查所在分支交易的合法性  
所有叶节点同步信息时检查邻近分支是否平衡，附近的账号是否正常。  

**冗余备份**  
少数矿工保存整个分支下的所有账目信息  
为了使整个网络更健壮，我们鼓励所有账户冗余保存临近分支的信息。
我们使用两种方法：  
普通账号可以审核临近分支的交易信息，获取奖励
对于非法交易，冻结临近账户信息直至其它分支账目平衡。  
临近节点的数量可以是1、3、7、15、31、63、255  

为了获取奖励，同时不受损失，所有在线节点都会集体维护整个网络。
因为有冗余存在，整个系统崩溃时，少数量节点便可以把整个网络重构起来。  
冗余备份发生在矿工记账完毕之后的信息广播  
网络恢复发生在各节点入网时的信息校对  

#### 6.4、争议处理  
**公示期**  
每笔交易都有一个公示期  
这个值可以在组织创建时设置，缺省24小时  
公示期内账单需要被其它节点审核。  
审核时如果发现有问题，则举报，相关账单进入争议流程。

**金额时间**  
每笔交易的金额大小不同，每个参与记账和审核者所质押的信用也是大小不同。  
鉴于此，我们提出了金额时间概念：  
金额时间=金额*时间   
对于交易  
金额=交易金额 时间=公示期  
对于审核和记账  
金额=质押信用额  时间=冻结期

**累计周期**  
累计（审核或公示）周期=累计的（审计或公示）金额时间 / 交易金额

**交易的安全阀值**
+ 最小的检查的用户个数   
+ 最小的累计审核周期  
安全阀值决定了最小的审核成本，可以计算出挖矿奖励或手续费的大致范围。 
正常一笔交易，需要的累计审核周期为1。
可以通过增加累计审核周期的方式。  
不同审核周期区间的价值不同，获取的系统奖励也有差异。

**争议流程和处罚机制**    
所有全网在线的节点都会审核一定范围的交易账单。  
每笔交易都需要有足够的保证金背书(冻结)足够的时间，以供更多的节点进行审核。
交易是同时多个节点处理，记账节点和备份记账节点都是随机分配的，避免串通的可能性, 任何一个节点有异议，都会进入争议流程，争议期相关金额会被冻结。全网对出错交易进行验证，根据验证结果进行投票，出错节点的保证金会被没收。
记账节点只能处理冻结资金所支持的交易金额，超出冻结资金的交易延时到账，直到交易的安全阀值

当事人检查整个交易是否合法，  
上级记账节点检查总账是否平衡，  
分支记账节点检查所有分支交易的合法性，  
叶节点检查所在分支的账目是否合法（非负），以免被连坐影响。

#### 6.5、合约服务  
合约服务类似于转账流程  
合约的内容包括合约代码、合约人的委托签名、合约的上限标的。
系统缺省由上一级的记账节点执行合约，用户也可以指定委托节点。 
对于复杂合约，风险不可控的情况下，可以提高处理结点的冻结金额。 相当于第三方替合约相关方用资产作了信用背书，同时获取背书收益。
出现争议，进入全网的争议处理流程，参与投票的节点通过冻结自身资产的方式进行投票。输的一方被没收冻结金额

#### 6.6、账号查询  
系统账户信息是公开的，普通用户是隐匿的，第三方不可查询。但可以通过用户出示账户信息，然后第三方通过公共账本中记录的摘要来核查信息的是否真实。检查各级分支摘要可以确认摘要是否合法真实

### 七、隐私和交易安全
#### 7.1、**隐私和共识**   
**两者的冲突**  
传统区块链中，共识机制是建立在信息透明基础上，如果信息完全隐匿无法实现共识机制。
账号信息隐匿我们就无法检查交易是否合法，交易方有可能使用了超出他所持量的资金。  

**冲突的解决**  
对于交易方之外的群体而言，了解交易信息的目的是不希望被他人的交易非法伤害，而不是希望知道交易的详细信息。如果能解决了这个问题，群体没必要知道双方的交易细节。  

**前提和基本准则**  
个人信息隐匿的前提和基本准则是：  交易双方和组织(其他人)之间互不伤害。   

#### 7.2、**交易安全性**    
基于"不被伤害”原则，必须要让组织的所有成员相信一个交易是合法的。  
7.2.1、**安全条件**  
交易合法要符合以下条件：  
+ **真实本意**  
交易是交易双方所确认的  

+ **杜绝无中生有**  
转出方要有足够的额度以供交易  
转账金额不能为负值  
交易后不出现负值账户  

+ **账目平衡**   
不考虑系统奖励，交易前后系统的总账不能变。  
对于系统奖励也可以当成组织账户向用户的转账，这样总账也是前后不变的。  

7.2.3、**安全分析**  
+ 交易双方  
  转入方会严格检查以上三个点，否则金额无法到自己的账户里。  
  同时因为非法交易会被组织处罚，所以转出方也会严格检查整个交易的参数和过程。  

+ 相关的节点组其他成员  
  非交易相关方，要确保自己不被伤害，需要确认其它账户的交易不存在“无中生有”并且“账目平衡”。

+ 其他节点组的用户  
  对于任何一个不包含交易方的节点组织成员，只需要确定交易双方所在的节点组不存在“无中生有”和“账目平衡”便可 。   

#### 7.3、**隐匿策略**  
**节点组遮蔽**  
如果节点组是一个结算单位，交易信息可以隐匿在一个节点组之内  
其他用户只需要关注这个节点组的总账目是否平衡合法便可。

**第三方遮蔽**  
如果交易有第三方背书，可以确保其他人不会因交易蒙受损失，交易信息则可以延后曝光。

**半透明网络**  
冗余备份的时候，一个账户的信息只被少数附近的账号所保存。   
远处的账号只能获取少数顶级分支节点的汇总信息，不清楚下层的账号信息。
既保证了交易信息的安全确认，又保证了信息的隐匿

**第三方不关注资金流向**  
现实社会，从隐私上讲，资金的流向比账户的金额更重要。  
但对第三方来说关注的是账目的合法和平衡。并不关注具体的资金流向。  
系统如果设置交易信息定期删除，在一定时期之后，资金流向是无法被追溯的。

#### 7.4、**隐匿方案**  
本方案中我们用以下的方式实现信息隐匿。  
**信用背书**  
交易可以指定第三方进行背书，缺省由记账节点完成。对于其他分支用户，交易是在分支上进行的。
因为背书人作了交易担保，相关交易第三方不会受损。

**邻居检查**  
交易完成之后，默克尔树发生变动，记账节点需要广播变动信息。
因为冗余备份关系，交易方的临近节点会拿到详细信息，对树和交易进行检查。
如果发生异常，则进入争议处理流程。
除了少数记账节点和邻近节点，绝大多数用户都获取不到交易的详细信息。

**多次转账**  
如果有人想查到详细的交易记录，需要在转账的时候接触交易的少数节点。  
这通常需要一定的时间和成本，用户可以通过多次转帐的方式，让资金在不同的分支进行流转。 使追溯成本提升到不可行的程度。

**跨组织交易**  
每个组织都有自己的共识体系，不同组织之间可以进行代币互换，不同组织之间的切换也会大大增加追溯的成本。  


### 八、数据处理和量化分析  
#### 数据存放
理论上，稀疏默克树是一个概率均衡的二叉树，越顶层分布的越均匀， 最底层会出现长短不一的情况。需要用方法消除长短链情况
另一方面账号是一个160位，作为数字处理十分不便，考虑到每8层是一个字节，我们把8层作为一个分层标准。
每个节点的信息我们按36字节计算（网络编号8字节+金额8字节+账号20字节）

**节点组**  
节点组最多可以存放256个节点，表达64层的不平衡子树。  
去除中间运算需求。 一个节点组的需要的直接空间上限大约是10k左右

**子数据库**  
在数据库中，小于256个节点组，我们放入同一个子数据库中。  拆分方法如上。
一个子数据库，最多可以保存256个节点组，65536个节点账户  
子数据库需要的空间上限大约是2.5M

**矿工记账数据库**  
在一个节点（用户）的数据库中，如果超256个子数据库，系统会把数据折分到其它节点之上。拆分方法如上。
一个记账用户，最多可以保存256个子数据库，16,777,216个节点账户  
一个矿工需要的空间上限大约是640M

**账本汇总信息**  
我们把最上层的节点组称之为账本状态，记录了最顶级的256个分支的账目情况。 包括摘要和分支汇总金额。
这部分信息大约要10k，需要实时同步到系统中的每个在线账号。
普通用户只需要关注总的状态和所在分支的相关节点信息便可。

#### 量化分析  
<!-- 分层的方式还需要优化一下，tbd -->
**设定系统规模**
参考比特币，目前的账号大约是3000多万个，每秒6.67笔的交易量。  
我们假定系统状态如下进行分析：    
+ 系统账号规模43亿（2的32次方）  
+ 并发交易量为100万笔/秒  
+ 心跳周期为1秒  
+ 节点选举周期为30分钟    

**规模分析**
这些信息大部分会分布在一个32层的网络中，记账节点进行分组，分别处理8，8，16层

**矿工磁盘分析**  
如果一个分支矿工处理一个子数据库（65536用户），涉及的数据是2.5M
如果一个分支矿工处理一个数据库（16,777,216用户），涉及的数据是640M
常见的存储介值能够完成上述工作。


**矿工内存分析**  
对于内存，因为网络中只涉及在线交易的账号。  
对于一二级矿工，大部分分支都需要在线处理，10k的信息都需要保存在内存中。  
对于低层矿工，只有30个交易，没有必要把所有信息放入内存，从数据库中读取相关分支链和兄弟分支的摘要便合。30x16x2x36字节，约34k字节，涉及的数据库操作90次。常见的存储介值能够完成上述工作。  

**矿工CPU分析**  
cpu主要用于验证和取摘要。  
对于一二级矿工，每个交易都计算，涉及的摘要次数是1600万次摘要处理。事实上不需要全部计算，一个周期（1秒）最多只需要全网计算一次，512次，涉及的数据量（摘要20字节），10k的数据量。
对于分支节点，除了取摘要，还要验证整个分支，30x（16+16），96次摘要操作。   
常见的CPU均能够完成上述工作。

**矿工网间通讯量**  
节点查找是DHT网络方式查找的，均衡到了各个节点上，忽略查找过程的通讯量。  
账本的网络结构是提前确定的，一个周期调整一次（30分钟），忽略确定网络的通讯量。  
用户的交易是直接找到各自相关方的分支节点进行处理的。30笔交易的通讯量是可控的。    

下面我们重点分析根节点矿工的通讯量：  
矿工需要向备份矿工同步信息，也需要向下级矿工同步信息。向备份矿工同步的数据量为每秒10k左右。 最多同时256个下级是2.5M/s. 如果网络不足，可以再分组广播。每层16用户，数据变为160k/s。 从顶级广播到普通用户从三次变为五次。
普通的家用网络能够完成上述工作。  

**矿工网间通讯时间**  
整个处理需要涉及三到四层节点。  
交易递交确认和交易验证保存是两个不同周期。  
交易递交的时候，需要递交到分支节点，一次通讯便可以完成。  
交易验证的时候，需要子节点向根节点递交，根节点处理完毕之后再向子节点传播一到两次。  
通讯时间上，大部分操作都可以在不超过十次通讯完成。网络正常时，合法交易均可在2秒之内得到确认回复。  

综上分析，利用数美元芯片数十美元的设备，普通家用网络，便可以完成43亿用户网络规模，并发100万的交易量。  

<!-- 分层的方式还需要优化一下，tbd -->

### 九、框架性概括
我们对上面的方案进行概括，其核心思想（思路）如下：

#### 9.1、**信用来自有意义的劳动**  
价值的来源是对他人有意义的劳动成果  
系统通过有意义的劳动成果，建立起最原始的信用  
每一个信用的源头都对应了一个劳动成果。  
而信用本身也可以交换生态内的产品和服务。  

作为对比，区块链网络中有意义的劳动仅仅是记账服务，这个在整个价值链中是相对比较低的工作。

#### 9.2、**一切交互行为基于信用**  
有了信用，网络上一切交互行为以信用为背书。
公私钥体系给了我们一个证明自己身份和信息的机制。
矿工记账者通过质押信用，让第三方相信他会无误工作，因为出错了会被扣除代币。  
通过冻结和仲裁机制，可以实现复杂的合约，支撑更大规模多方互动。
所有这些操作只需要依赖的是最基本的PKI体系算法，最低端设备都可以低成本高效完成。

作为对比，传统区块链需要依赖昂贵的设备，消耗昂贵的电费。

#### 9.3、**时空完整性来自摘要和时序（一致性）**  
系统根据160位账号空间定义了一颗稀疏的稀疏默克尔树，用于记录所有的当前账号状态信息。  
所有信息存放在叶节点，通过一级一级的摘要汇总到根节点。可以用一个摘要来表达整个系统的状态。  
通过时序协调各节点，并记录了各个阶段的时空状态。时序也解决了分布式网络中的一致性问题。

#### 9.4、**分工协同提高整理处理能力**  
在本方案中可以按网络规模把处理节点进行分层，具体的交易数据保存在用户节点，交易的确认在分支节点，全网同步的只有极小数据量的摘要和汇总信息。

通过设置适当的备份节点数目提高网络的健壮性和稳定性。  

作为对比，传统区块链网络中，扣除意义不大的工作量证明矿工，真正有意义的工作都是全节点完成的。所有的记账工作都需要所有全节点一起参与。这限制了整个网络的规模和工作能力。  


#### 9.5、**背书和灰度解决隐私问题** 

### 十、对比优势
对比传统的区块链，Leither有以下优势：  
**功能**  
通过弥媒和应用系统，能够以用户为中心重构当前大部分互联网平台业务；  
通过组织和共识机制，能够实现以太坊上绝大部分功能，把参与方组织起来；    
两者结合，可以从寡头手中把互联网交还给用户。  

**价值**  
传统区块链实现的业务功能是为他人记账。  
本方案中每个组织都有一个互联网应用的去中心使命，目标都是让用户完全把控自己的数据，最大程度满足用户需求。
每个参与者的每个行为动作都有具体的现实价值，把互联网寡头所攫取的不正常利益以用户为中心进行了再分配  

**成本**  
传统区块链的挖矿损耗极大，需要购置高昂的矿机，耗费大量的电力去完成最基础的记账工作。  
本方案中相应的工作被完成互联网业务必须的工作替代了。机顶盒、路由、NAS、手机，甚至数美元的设备都可以提供远高于矿机的实际价值服务，换取收益。 

**效率**  
系统可以根据业务规模弹性伸缩，相应的工作通过共识均衡到了普通节点。  
业务量越大，节点数越多，相应的网络处理能力越强，可以实现远超传统区块链的服务能力。因为效率高，任何几个节点都可以构建自己的业务和共识机制。  

**隐私**  
传统区块链项目，每个账号的账目流动都是透明的，虽然账号隐匿，但是可通过账目信息分析出后面的数据信息。   
在本方案中，除了用户最早的贡献发放需要用于审核的公示。后续的信息只针对当事人或极少数节点开放。整个网络是一张有灰度的网络，创建者用户可以设置透明度，能够更好的保护隐私。  

**合规**  
本方案的代币有相应的服务相对应，更象现实生活中的贡献记录、商品积分、借条、股份、契约 、提货券、Q币等形态，现实生活中都有大量类似的合法行为，只需参考遵守便可做到合规。  
业务形态上，类似最早的淘宝业务，完全去中心化，以用户个人的名义进行，现行法规都比较宽松，可以合法完成大量商业实体无法完成的任务。  
因为合约能接触到具体的业务数据，避免了区块链合约只能处理虚拟币等非法业务  

